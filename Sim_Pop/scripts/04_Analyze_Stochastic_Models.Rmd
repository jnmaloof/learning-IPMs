---
title: "04_Analyze_Stochastic_Models"
author: "Julin Maloof"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(patchwork)
library(here)
library(future)
library(furrr)
plan(multisession(workers=4))
```

```{r}
mem.maxVSize(36000)
simulation.list <- readRDS(here("Sim_Pop" , "output", "simpop_100sims_100gen_2025-09-27.Rds"))
```

For now, reduce to the last week to make the data size more manageable.  (MAYBE THIS SHOULD BE DONE WHEN GENERATING THE DATA?)
```{r}
#92 seconds
system.time({
simulation.list.small <- future_map(simulation.list, function(sim) {
  sim <- sim %>% select(-seed) %>%
    mutate(pop = map(pop, \(x) filter(x, week==max(week)))) 
},
  .options = furrr_options(seed = TRUE) ) 
})
rm(simulation.list)
```

```{r}
system.time(
  sims.df <- bind_rows(simulation.list.small, .id = "sim")
)

system.time(sims.df <- sims.df %>% unnest(pop))
```

summary stats
```{r}
system.time({
sims.summary <- sims.df %>%
      group_by(sim, gen) %>%
      summarize(
        germinated = mean(germinated, na.rm = TRUE),
        established = mean(established, na.rm = TRUE),
        y1surv = mean(y1surv, na.rm = TRUE),
        size = mean(size, na.rm = TRUE),
        .groups = "drop"  
      )
})
sims.summary
```

```{r, fig.height=5, fig.width=9}
sims.summary %>%
  pivot_longer(c(germinated, established, y1surv), names_to = "trait", values_to = "proportion") %>%
  ggplot(aes(x=gen, y=proportion)) +
  geom_line(alpha=.05, aes(group=sim)) +
  geom_smooth(se = FALSE) +
  facet_wrap(~trait, scales="free_y")
```

```{r}
sims.summary %>%
  ggplot(aes(x=gen, y=size)) +
  geom_line(alpha=.05, aes(group=sim)) +
  geom_smooth(se = FALSE)
```

